<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Fan District Association ‚Äì The Fan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dae3192f81785cf0e6fe7ca13257d296.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">The Fan</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#fan-district-association" id="toc-fan-district-association" class="nav-link active" data-scroll-target="#fan-district-association">Fan District Association</a>
  <ul class="collapse">
  <li><a href="#fda---key-measures" id="toc-fda---key-measures" class="nav-link" data-scroll-target="#fda---key-measures">FDA - Key measures</a>
  <ul class="collapse">
  <li><a href="#area" id="toc-area" class="nav-link" data-scroll-target="#area">Area</a></li>
  <li><a href="#examples-of-records-sharing-the-same-addresslabel" id="toc-examples-of-records-sharing-the-same-addresslabel" class="nav-link" data-scroll-target="#examples-of-records-sharing-the-same-addresslabel">Examples of records sharing the same AddressLabel</a></li>
  <li><a href="#examples-of-non-unit-addresses-with-unit-parts-in-addresslabel" id="toc-examples-of-non-unit-addresses-with-unit-parts-in-addresslabel" class="nav-link" data-scroll-target="#examples-of-non-unit-addresses-with-unit-parts-in-addresslabel">Examples of non-unit addresses with unit parts in AddressLabel</a></li>
  <li><a href="#fix-these-issues-found-above." id="toc-fix-these-issues-found-above." class="nav-link" data-scroll-target="#fix-these-issues-found-above.">Fix these issues found above.</a></li>
  <li><a href="#examples-of-non-unit-addreses-sharing-the-same-longlat" id="toc-examples-of-non-unit-addreses-sharing-the-same-longlat" class="nav-link" data-scroll-target="#examples-of-non-unit-addreses-sharing-the-same-longlat">Examples of non-unit addreses sharing the same long/lat</a></li>
  <li><a href="#fix-jitter-addresses" id="toc-fix-jitter-addresses" class="nav-link" data-scroll-target="#fix-jitter-addresses">Fix: jitter addresses</a></li>
  <li><a href="#example-unit-addresses-without-non-unit-base-address" id="toc-example-unit-addresses-without-non-unit-base-address" class="nav-link" data-scroll-target="#example-unit-addresses-without-non-unit-base-address">Example: Unit addresses without non-unit base address</a></li>
  <li><a href="#list-of-non-unit-addresses-where-baseaddresslabel-addresslabel" id="toc-list-of-non-unit-addresses-where-baseaddresslabel-addresslabel" class="nav-link" data-scroll-target="#list-of-non-unit-addresses-where-baseaddresslabel-addresslabel">List of non-unit addresses where baseaddresslabel &lt;&gt; addressLabel</a></li>
  <li><a href="#addresses-with-the-top-20-unit-counts." id="toc-addresses-with-the-top-20-unit-counts." class="nav-link" data-scroll-target="#addresses-with-the-top-20-unit-counts.">Addresses with the top 20 unit counts.</a></li>
  <li><a href="#delete-parcels-with-duplicate-geometries" id="toc-delete-parcels-with-duplicate-geometries" class="nav-link" data-scroll-target="#delete-parcels-with-duplicate-geometries">Delete parcels with duplicate geometries</a></li>
  <li><a href="#merge-addresses-to-parcels" id="toc-merge-addresses-to-parcels" class="nav-link" data-scroll-target="#merge-addresses-to-parcels">Merge addresses to parcels</a></li>
  <li><a href="#frequency-of-addresses-counts-in-parcels" id="toc-frequency-of-addresses-counts-in-parcels" class="nav-link" data-scroll-target="#frequency-of-addresses-counts-in-parcels">Frequency of addresses counts in parcels</a></li>
  <li><a href="#why-so-many-odd-parcel-counts" id="toc-why-so-many-odd-parcel-counts" class="nav-link" data-scroll-target="#why-so-many-odd-parcel-counts">Why so many odd parcel counts?</a></li>
  <li><a href="#any-now-digging-into-2710-stuart" id="toc-any-now-digging-into-2710-stuart" class="nav-link" data-scroll-target="#any-now-digging-into-2710-stuart">Any now digging into 2710 Stuart</a></li>
  <li><a href="#all-the-duplicate-parcels" id="toc-all-the-duplicate-parcels" class="nav-link" data-scroll-target="#all-the-duplicate-parcels">All the duplicate parcels</a></li>
  <li><a href="#exploring-parcels-with-more-than-one-address" id="toc-exploring-parcels-with-more-than-one-address" class="nav-link" data-scroll-target="#exploring-parcels-with-more-than-one-address">Exploring parcels with more than one address</a></li>
  </ul></li>
  <li><a href="#available-columns" id="toc-available-columns" class="nav-link" data-scroll-target="#available-columns">Available columns</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Fan District Association</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The City of Richmond maintains an arcgis geodata repository called <a href="https://richmond-geo-hub-cor.hub.arcgis.com">Richmond GeoHub</a>.</p>
<p>Data on the geohub are organized into key areas. For our analysis, we‚Äôll be using the following data sources.</p>
<dl>
<dt><a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/674d645c444f4191998f0ebb96e56047_0/explore?location=37.527383%2C-77.493413%2C10.99">Addresses</a></dt>
<dd>
All of the official, mapped inventory of all unit and non-unit-based addresses in the City. Includes only active addresses.
</dd>
<dt><a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/fbfce2aab2a44c05bc0abc2d6ea7e54a_0/explore?location=37.525465%2C-77.493422%2C10.60">Parcels</a></dt>
<dd>
City of Richmond property ownership information, mapped by land ownership (parcels).
</dd>
<dt><a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/be39ce592f3e4419babe11d1b967e2f3_0/explore?location=37.528836%2C-77.494197%2C10.96">Civic Associations</a></dt>
<dd>
Represents civic organization boundaries in the city of Richmond, Virginia.
</dd>
<dt><a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/38bd0df47c6440528c2ef22daaf81883_0/explore?location=37.550339%2C-77.468606%2C14.93">National Historic Districts</a></dt>
<dd>
Represents districts and sites that are listed on the National Register of Historic Places (Federal designation) and the Virginia Landmarks Register (State designation).
</dd>
<dt><a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/7a0ffef23d16461e9728c065f27b2790_0/explore?location=37.525021%2C-77.493427%2C10.73">Neighborhoods</a></dt>
<dd>
City of Richmond Neighborhoods.
</dd>
</dl>
<p>For our Fan District analysis we will be working with <a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/be39ce592f3e4419babe11d1b967e2f3_0/explore?location=37.528836%2C-77.494197%2C10.96">Civic Associations</a> to get the formal boundary of the <em>Fan District Association</em>.</p>
<p>We then use that boundary to determine <a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/674d645c444f4191998f0ebb96e56047_0/explore?location=37.527383%2C-77.493413%2C10.99">Addresses</a> and <a href="https://richmond-geo-hub-cor.hub.arcgis.com/datasets/fbfce2aab2a44c05bc0abc2d6ea7e54a_0/explore?location=37.525465%2C-77.493422%2C10.60">Parcels</a> in the <em>Fan District Association</em></p>
<section id="fan-district-association" class="level1">
<h1>Fan District Association</h1>
<div id="212e6a2d" class="cell" data-execution_count="2">
<div class="cell-output cell-output-stdout">
<pre><code>Found Civic_Associations:  /home/john/projects/ssg-thefan-analysis/precious/Civic_Associations-2025-05-16.geojson
Found Addresses:  /home/john/projects/ssg-thefan-analysis/precious/Addresses-2025-09-25.geojson
Found Parcels:  /home/john/projects/ssg-thefan-analysis/precious/Parcels-2025-09-25.geojson</code></pre>
</div>
</div>
<div id="b3fcdd91" class="cell" data-execution_count="3">
<div class="cell-output cell-output-stdout">
<pre><code>Saving: Addresses_in_fan.csv
Saving: Parcels_in_fan.csv</code></pre>
</div>
</div>
<section id="fda---key-measures" class="level2">
<h2 class="anchored" data-anchor-id="fda---key-measures">FDA - Key measures</h2>
<section id="area" class="level3">
<h3 class="anchored" data-anchor-id="area">Area</h3>
<div id="5a14f439" class="cell" data-execution_count="4">
<div class="cell-output cell-output-stdout">
<pre><code>Fan District Association: Area: 24,564,893 sq.ft.,  563.93 acres, 0.881 sq.miles
Fan District Association: Area: 2,282,153 sq.m, 228.215 hectares, 2.282 sq.km</code></pre>
</div>
</div>
</section>
<section id="examples-of-records-sharing-the-same-addresslabel" class="level3">
<h3 class="anchored" data-anchor-id="examples-of-records-sharing-the-same-addresslabel">Examples of records sharing the same AddressLabel</h3>
<div id="d07e87ad" class="cell" data-execution_count="5">
<div class="cell-output cell-output-stdout">
<pre><code>Total duplicated AddressLabel records: 2
Number of unique duplicated labels: 1

Examples of duplicated AddressLabels:
                      AddressLabel UnitType UnitValue
100329  801 W Franklin St Room 503     Room       503
100338  801 W Franklin St Room 503     Room       503</code></pre>
</div>
</div>
</section>
<section id="examples-of-non-unit-addresses-with-unit-parts-in-addresslabel" class="level3">
<h3 class="anchored" data-anchor-id="examples-of-non-unit-addresses-with-unit-parts-in-addresslabel">Examples of non-unit addresses with unit parts in AddressLabel</h3>
<div id="42d9add7" class="cell" data-execution_count="6">
<div class="cell-output cell-output-stdout">
<pre><code>üîç Found 716 rows where AddressLabel ends with a recognizable UnitType + value and UnitType is missing.

üß™ Sample rows:
                        AddressLabel UnitType UnitValue
63    517 N Arthur Ashe Blvd Unit G9     None      None
70    517 N Arthur Ashe Blvd Unit G1     None      None
138  517 N Arthur Ashe Blvd Unit G27     None      None
149  517 N Arthur Ashe Blvd Unit G15     None      None
154  517 N Arthur Ashe Blvd Unit G14     None      None</code></pre>
</div>
</div>
</section>
<section id="fix-these-issues-found-above." class="level3">
<h3 class="anchored" data-anchor-id="fix-these-issues-found-above.">Fix these issues found above.</h3>
<div id="94ba2974" class="cell" data-execution_count="7">
<div class="cell-output cell-output-stdout">
<pre><code>
‚úÖ Extracted UnitType and UnitValue for 716 rows.</code></pre>
</div>
</div>
</section>
<section id="examples-of-non-unit-addreses-sharing-the-same-longlat" class="level3">
<h3 class="anchored" data-anchor-id="examples-of-non-unit-addreses-sharing-the-same-longlat">Examples of non-unit addreses sharing the same long/lat</h3>
<div id="1683a2ef" class="cell" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>üìç Total base address rows with duplicate coordinates: 66
üîÅ Unique (lat, lon) pairs with duplicates: 16

üîç Example duplicates (UnitType is None, by lat/lon):

Coordinates: (37.54774625, -77.45877807) ‚Äî 34 records
         AddressLabel UnitType UnitValue   Latitude  Longitude
85486  1403 Floyd Ave     None      None  37.547746 -77.458778
79979  1405 Floyd Ave     None      None  37.547746 -77.458778
80471  1407 Floyd Ave     None      None  37.547746 -77.458778
76619  1409 Floyd Ave     None      None  37.547746 -77.458778
79982  1411 Floyd Ave     None      None  37.547746 -77.458778
79983  1413 Floyd Ave     None      None  37.547746 -77.458778
85488  1415 Floyd Ave     None      None  37.547746 -77.458778
80475  1417 Floyd Ave     None      None  37.547746 -77.458778
80472  1419 Floyd Ave     None      None  37.547746 -77.458778
79980  1421 Floyd Ave     None      None  37.547746 -77.458778
79981  1423 Floyd Ave     None      None  37.547746 -77.458778
80691  1425 Floyd Ave     None      None  37.547746 -77.458778
85487  1427 Floyd Ave     None      None  37.547746 -77.458778
76618  1429 Floyd Ave     None      None  37.547746 -77.458778
80689  1431 Floyd Ave     None      None  37.547746 -77.458778
85483  1433 Floyd Ave     None      None  37.547746 -77.458778
80692  1435 Floyd Ave     None      None  37.547746 -77.458778
80468  1437 Floyd Ave     None      None  37.547746 -77.458778
80693  1439 Floyd Ave     None      None  37.547746 -77.458778
80473  1441 Floyd Ave     None      None  37.547746 -77.458778
85482  1443 Floyd Ave     None      None  37.547746 -77.458778
80690  1445 Floyd Ave     None      None  37.547746 -77.458778
85485  1447 Floyd Ave     None      None  37.547746 -77.458778
80469  1449 Floyd Ave     None      None  37.547746 -77.458778
80243  1451 Floyd Ave     None      None  37.547746 -77.458778
85484  1453 Floyd Ave     None      None  37.547746 -77.458778
80470  1455 Floyd Ave     None      None  37.547746 -77.458778
85426  1457 Floyd Ave     None      None  37.547746 -77.458778
76617  1459 Floyd Ave     None      None  37.547746 -77.458778
80474  1461 Floyd Ave     None      None  37.547746 -77.458778
79904  1465 Floyd Ave     None      None  37.547746 -77.458778
79905  1467 Floyd Ave     None      None  37.547746 -77.458778
79978  1469 Floyd Ave     None      None  37.547746 -77.458778
80244  1471 Floyd Ave     None      None  37.547746 -77.458778</code></pre>
</div>
</div>
<div id="e171584c" class="cell" data-execution_count="9">
<div class="cell-output cell-output-stdout">
<pre><code>
üîç First record from each duplicate (UnitType is None, by lat/lon):
1403 Floyd Ave | 34 records | (37.54774625, -77.45877807)
708 1/2 W Grace St | 2 records | (37.54886389, -77.44932289)
800 W Grace St | 3 records | (37.5494549, -77.45003694)
2601 1/2 W Main St | 2 records | (37.55178826, -77.47347259)
1625 1/2 W Grace St | 3 records | (37.55373633, -77.45790774)
508 1 Allison St | 2 records | (37.55572891, -77.46464775)
2505 C Stuart Ave | 2 records | (37.55583431, -77.46986291)
500 1/2 N Stafford Ave | 2 records | (37.55655244, -77.46784226)
502 1/2 N Stafford Ave | 2 records | (37.55661253, -77.46778968)
2500 1/2 Kensington Ave | 2 records | (37.55715189, -77.46891095)
2502 1/2 Kensington Ave | 2 records | (37.55721386, -77.46903156)
2226 1/2 W Grace St | 2 records | (37.55783315, -77.46423125)
2620 W Grace St | 2 records | (37.56040195, -77.46847792)
2624 W Grace St | 2 records | (37.56043825, -77.46854847)
2628 W Grace St | 2 records | (37.56047908, -77.46862291)
2632 W Grace St | 2 records | (37.56052296, -77.46869797)</code></pre>
</div>
</div>
</section>
<section id="fix-jitter-addresses" class="level3">
<h3 class="anchored" data-anchor-id="fix-jitter-addresses">Fix: jitter addresses</h3>
<div id="6af6fe9d" class="cell" data-execution_count="10">
<div class="cell-output cell-output-stdout">
<pre><code>‚úÖ Jittered coordinates applied to duplicate lat/lon groups.</code></pre>
</div>
</div>
</section>
<section id="example-unit-addresses-without-non-unit-base-address" class="level3">
<h3 class="anchored" data-anchor-id="example-unit-addresses-without-non-unit-base-address">Example: Unit addresses without non-unit base address</h3>
<div id="983891f1" class="cell" data-execution_count="11">
<div class="cell-output cell-output-stdout">
<pre><code>Total unit addresses: 7326
Unit addresses with missing base address: 1

Examples of missing base addresses:
              AddressLabel BaseAddressLabel UnitType UnitValue
90017  1501 Hanover Unit A     1501 Hanover     Unit         A</code></pre>
</div>
</div>
</section>
<section id="list-of-non-unit-addresses-where-baseaddresslabel-addresslabel" class="level3">
<h3 class="anchored" data-anchor-id="list-of-non-unit-addresses-where-baseaddresslabel-addresslabel">List of non-unit addresses where baseaddresslabel &lt;&gt; addressLabel</h3>
<div id="a174a712" class="cell" data-execution_count="12">
<div class="cell-output cell-output-stdout">
<pre><code>Total base addresses (UnitType is null): 3987
Matching AddressLabel == BaseAddressLabel: 3878
Non-matching AddressLabel != BaseAddressLabel: 109

Examples of mismatched base addresses:
                   AddressLabel        BaseAddressLabel
35           2032 Park Ave Rear           2032 Park Ave
43       1811 Monument Ave Rear       1811 Monument Ave
54       1815 Monument Ave Rear       1815 Monument Ave
64  211 N Arthur Ashe Blvd Rear  211 N Arthur Ashe Blvd
97        1711 Hanover Ave Rear        1711 Hanover Ave</code></pre>
</div>
</div>
</section>
<section id="addresses-with-the-top-20-unit-counts." class="level3">
<h3 class="anchored" data-anchor-id="addresses-with-the-top-20-unit-counts.">Addresses with the top 20 unit counts.</h3>
<div id="4a2821c1" class="cell" data-execution_count="14">
<div class="cell-output cell-output-stdout">
<pre><code>               AddressLabel    BaseAddressLabel  UnitCount UnitType
77001     710 W Franklin St   710 W Franklin St        981     None
57411       1025 W Grace St     1025 W Grace St        255     None
70222         406 Shafer St       406 Shafer St        155     None
17023       1363 W Broad St     1363 W Broad St        114     None
68256       2501 W Broad St     2501 W Broad St        109     None
13924     801 W Franklin St   801 W Franklin St         94     None
23850        933 W Broad St      933 W Broad St         90     None
69904     1600 Monument Ave   1600 Monument Ave         64     None
43551     900 W Franklin St   900 W Franklin St         63     None
74594  1333 W Broad St RSPS     1333 W Broad St         58     None
23632       1333 W Broad St     1333 W Broad St         58     None
70548     612 W Franklin St   612 W Franklin St         56     None
83188       501 N Allen Ave     501 N Allen Ave         55     None
70067    1030 W Franklin St  1030 W Franklin St         54     None
77910        413 Stuart Cir      413 Stuart Cir         37     None
69576        1005 Grove Ave      1005 Grove Ave         36     None
84307       2621 Stuart Ave     2621 Stuart Ave         36     None
13398       1301 W Broad St     1301 W Broad St         36     None
63125     1630 Monument Ave   1630 Monument Ave         36     None
69481    1108 W Franklin St  1108 W Franklin St         36     None</code></pre>
</div>
</div>
</section>
<section id="delete-parcels-with-duplicate-geometries" class="level3">
<h3 class="anchored" data-anchor-id="delete-parcels-with-duplicate-geometries">Delete parcels with duplicate geometries</h3>
<div id="9173768a" class="cell" data-execution_count="15">
<div class="cell-output cell-output-stdout">
<pre><code>Original count: 4224, After deduplication: 3464</code></pre>
</div>
</div>
<p>List out duplicate parcels</p>
<div id="197bcae6" class="cell" data-execution_count="16">
<div class="cell-output cell-output-stdout">
<pre><code>Empty DataFrame
Columns: [ParcelID, PIN, geom_count]
Index: []</code></pre>
</div>
</div>
</section>
<section id="merge-addresses-to-parcels" class="level3">
<h3 class="anchored" data-anchor-id="merge-addresses-to-parcels">Merge addresses to parcels</h3>
</section>
<section id="frequency-of-addresses-counts-in-parcels" class="level3">
<h3 class="anchored" data-anchor-id="frequency-of-addresses-counts-in-parcels">Frequency of addresses counts in parcels</h3>
<div id="93afbad5" class="cell" data-execution_count="18">
<div class="cell-output cell-output-stdout">
<pre><code>üìä Frequency of address counts per parcel:
AddressList
0      2195
1       138
2       518
3       204
4       145
5        55
6        54
7        20
8         9
9        14
10        7
11        2
12       38
13        4
14        2
15        2
16        1
17        2
18        7
19        3
20        1
21        1
22        1
23        2
24        4
25        3
27        1
28        1
30        3
31        1
32        2
34        2
35        2
36        5
37        1
54        1
55        1
56        1
58        1
63        1
64        1
90        1
94        1
96        1
109       1
114       1
155       1
255       1
992       1
Name: count, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="why-so-many-odd-parcel-counts" class="level3">
<h3 class="anchored" data-anchor-id="why-so-many-odd-parcel-counts">Why so many odd parcel counts?</h3>
<p>let‚Äôs look at a few parcels with 12 addresses.</p>
<div id="47fa49b8" class="cell" data-execution_count="19">
<div class="cell-output cell-output-stdout">
<pre><code>üì¶ Parcels with exactly 12 addresses:

Parcel Index: 386.0
Addresses:
  - 1711 Hanover Ave Apt 1
  - 1711 Hanover Ave Apt 10
  - 1711 Hanover Ave Apt 6
  - 1711 Hanover Ave Apt 7
  - 1711 Hanover Ave Apt 8
  - 1711 Hanover Ave Apt 9
  - 1711 Hanover Ave Apt 11
  - 1711 Hanover Ave Apt 12
  - 1711 Hanover Ave Apt 2
  - 1711 Hanover Ave Apt 3
  - 1711 Hanover Ave Apt 4
  - 1711 Hanover Ave Apt 5
----------------------------------------
Parcel Index: 478.0
Addresses:
  - 805 N Arthur Ashe Blvd Apt 1
  - 805 N Arthur Ashe Blvd Apt 10
  - 805 N Arthur Ashe Blvd Apt 11
  - 805 N Arthur Ashe Blvd Apt 7
  - 805 N Arthur Ashe Blvd Apt 8
  - 805 N Arthur Ashe Blvd Apt 9
  - 805 N Arthur Ashe Blvd Apt 12
  - 805 N Arthur Ashe Blvd Apt 2
  - 805 N Arthur Ashe Blvd Apt 3
  - 805 N Arthur Ashe Blvd Apt 4
  - 805 N Arthur Ashe Blvd Apt 5
  - 805 N Arthur Ashe Blvd Apt 6
----------------------------------------
Parcel Index: 541.0
Addresses:
  - 2710 Stuart Ave Unit 12
  - 2710 Stuart Ave Unit 3
  - 2710 Stuart Ave Unit 5
  - 2710 Stuart Ave Unit 6
  - 2710 Stuart Ave Unit 7
  - 2710 Stuart Ave Unit 8
  - 2710 Stuart Ave Unit 1
  - 2710 Stuart Ave Unit 10
  - 2710 Stuart Ave Unit 11
  - 2710 Stuart Ave Unit 2
  - 2710 Stuart Ave Unit 4
  - 2710 Stuart Ave Unit 9
----------------------------------------
Parcel Index: 674.0
Addresses:
  - 2705 Hanover Ave Unit 1
  - 2705 Hanover Ave Unit 11
  - 2705 Hanover Ave Unit 5
  - 2705 Hanover Ave Unit 7
  - 2705 Hanover Ave Unit 9
  - 2705 Hanover Ave Unit 12
  - 2705 Hanover Ave Unit 2
  - 2705 Hanover Ave Unit 3
  - 2705 Hanover Ave Unit 4
  - 2705 Hanover Ave Unit 10
  - 2705 Hanover Ave Unit 6
  - 2705 Hanover Ave Unit 8
----------------------------------------
Parcel Index: 1138.0
Addresses:
  - 101 N Stafford Ave Unit 1
  - 101 N Stafford Ave Unit 6
  - 101 N Stafford Ave Unit 7
  - 101 N Stafford Ave Unit 8
  - 101 N Stafford Ave Unit 9
  - 101 N Stafford Ave Unit 2
  - 101 N Stafford Ave Unit 4
  - 101 N Stafford Ave Unit 11
  - 101 N Stafford Ave Unit 3
  - 101 N Stafford Ave Unit 5
  - 101 N Stafford Ave Unit 10
  - 101 N Stafford Ave Unit 12
----------------------------------------</code></pre>
</div>
</div>
</section>
<section id="any-now-digging-into-2710-stuart" class="level3">
<h3 class="anchored" data-anchor-id="any-now-digging-into-2710-stuart">Any now digging into 2710 Stuart</h3>
<div id="e8efd2c6" class="cell" data-execution_count="20">
<div class="cell-output cell-output-stdout">
<pre><code>üì¶ Parcels containing addresses for '2710 Stuart Ave':

Parcel Index: 541.0
ParcelID: 95773
PIN: W0001206026
CountOfPIN: 1
OwnerName: Pope Meghan
AsrLocationBldgNo: 2710
MailAddress: 2710 Stuart Ave Unit 1
MailCity: Richmond
MailState: VA
MailZip: 23220
AssessmentDate: Thu, 01 Jan 2026 05:00:00 GMT
LandValue: 35000.0
DwellingValue: 202000.0
TotalValue: 237000.0
LandSqFt: 1.0
ProvalAsmtNhood: 602
TaxExemptCode: None
PropertyClassID: 211
PropertyClass: R Condo Residential 12-49 Unit
LandUse: Multi-Family
Mailable: 1
MaskedOwner: None
GlobalID_left: 04e3f49f-4e14-4775-8fa5-fc2831cecee4
geometry: POLYGON ((-77.4723776361122 37.5571857214691, -77.4724554510198 37.5570456357209, -77.4726614487711 37.5571188306328, -77.4725836247857 37.5572596030671, -77.4723776361122 37.5571857214691))
ID: 0350
Name: Fan District Association
GlobalID_right: 56def863-fe53-4df4-a7a7-c37df4b0fac2
Shape__Area: 24556584.23828125
Shape__Length: 22599.19121067267
geom_wkt: POLYGON ((-77.472378 37.557186, -77.472455 37.557046, -77.472661 37.557119, -77.472584 37.55726, -77.472378 37.557186))
geom_count: 1
AddressList:
  - 2710 Stuart Ave Unit 12
  - 2710 Stuart Ave Unit 3
  - 2710 Stuart Ave Unit 5
  - 2710 Stuart Ave Unit 6
  - 2710 Stuart Ave Unit 7
  - 2710 Stuart Ave Unit 8
  - 2710 Stuart Ave Unit 1
  - 2710 Stuart Ave Unit 10
  - 2710 Stuart Ave Unit 11
  - 2710 Stuart Ave Unit 2
  - 2710 Stuart Ave Unit 4
  - 2710 Stuart Ave Unit 9
AddressIdList:
  - 3158670
  - 3158661
  - 3158663
  - 3158664
  - 3158665
  - 3158666
  - 3158659
  - 3158668
  - 3158669
  - 3158660
  - 3158662
  - 3158667
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="all-the-duplicate-parcels" class="level3">
<h3 class="anchored" data-anchor-id="all-the-duplicate-parcels">All the duplicate parcels</h3>
</section>
<section id="exploring-parcels-with-more-than-one-address" class="level3">
<h3 class="anchored" data-anchor-id="exploring-parcels-with-more-than-one-address">Exploring parcels with more than one address</h3>
<p>These lists can be used later in tool tips.</p>
<div id="4997b4de" class="cell" data-execution_count="22">
<div class="cell-output cell-output-stdout">
<pre><code>üì¶ Parcels with multiple addresses:

Parcel Index: 27.0
Address Count: 3
Addresses:
  - 2037 Monument Ave Apt Gar
  - 2037 Monument Ave Apt 1
  - 2037 Monument Ave Apt 2
----------------------------------------
Parcel Index: 132.0
Address Count: 2
Addresses:
  - 2117 Grove Ave Apt 1
  - 2117 Grove Ave Apt 2
----------------------------------------
Parcel Index: 134.0
Address Count: 2
Addresses:
  - 2236 W Grace St Apt 1
  - 2236 W Grace St Apt 2
----------------------------------------
Parcel Index: 168.0
Address Count: 255
Addresses:
  - 1025 W Grace St Apt 10005
  - 1025 W Grace St Apt 1001
  - 1025 W Grace St Apt 922
  - 1025 W Grace St Apt 916
  - 1025 W Grace St Apt 917
  - 1025 W Grace St Apt 918
  - 1025 W Grace St Apt 1005
  - 1025 W Grace St Apt 1006
  - 1025 W Grace St Apt 1007
  - 1025 W Grace St Apt 1011
  - 1025 W Grace St Apt 1012
  - 1025 W Grace St Apt 1013
  - 1025 W Grace St Apt 1002
  - 1025 W Grace St Apt 1003
  - 1025 W Grace St Apt 1004
  - 1025 W Grace St Apt 1017
  - 1025 W Grace St Apt 1018
  - 1025 W Grace St Apt 1019
  - 1025 W Grace St Apt 1008
  - 1025 W Grace St Apt 1009
  - 1025 W Grace St Apt 1010
  - 1025 W Grace St Apt 1101
  - 1025 W Grace St Apt 1102
  - 1025 W Grace St Apt 1103
  - 1025 W Grace St Apt 1014
  - 1025 W Grace St Apt 1015
  - 1025 W Grace St Apt 1016
  - 1025 W Grace St Apt 1107
  - 1025 W Grace St Apt 1108
  - 1025 W Grace St Apt 1109
  - 1025 W Grace St Apt 1020
  - 1025 W Grace St Apt 1021
  - 1025 W Grace St Apt 1022
  - 1025 W Grace St Apt 1112
  - 1025 W Grace St Apt 1113
  - 1025 W Grace St Apt 1114
  - 1025 W Grace St Apt 1104
  - 1025 W Grace St Apt 1105
  - 1025 W Grace St Apt 1106
  - 1025 W Grace St Apt 1118
  - 1025 W Grace St Apt 1119
  - 1025 W Grace St Apt 112
  - 1025 W Grace St Apt 111
  - 1025 W Grace St Apt 1110
  - 1025 W Grace St Apt 1111
  - 1025 W Grace St Apt 113
  - 1025 W Grace St Apt 114
  - 1025 W Grace St Apt 115
  - 1025 W Grace St Apt 1115
  - 1025 W Grace St Apt 1116
  - 1025 W Grace St Apt 1117
  - 1025 W Grace St Apt 119
  - 1025 W Grace St Apt 120
  - 1025 W Grace St Apt 1201
  - 1025 W Grace St Apt 1120
  - 1025 W Grace St Apt 1121
  - 1025 W Grace St Apt 1122
  - 1025 W Grace St Apt 1205
  - 1025 W Grace St Apt 1206
  - 1025 W Grace St Apt 1207
  - 1025 W Grace St Apt 116
  - 1025 W Grace St Apt 117
  - 1025 W Grace St Apt 118
  - 1025 W Grace St Apt 1210
  - 1025 W Grace St Apt 1211
  - 1025 W Grace St Apt 1212
  - 1025 W Grace St Apt 1202
  - 1025 W Grace St Apt 1203
  - 1025 W Grace St Apt 1204
  - 1025 W Grace St Apt 1216
  - 1025 W Grace St Apt 1217
  - 1025 W Grace St Apt 1218
  - 1025 W Grace St Apt 1208
  - 1025 W Grace St Apt 1209
  - 1025 W Grace St Apt 121
  - 1025 W Grace St Apt 1221
  - 1025 W Grace St Apt 1222
  - 1025 W Grace St Apt 201
  - 1025 W Grace St Apt 1213
  - 1025 W Grace St Apt 1214
  - 1025 W Grace St Apt 1215
  - 1025 W Grace St Apt 205
  - 1025 W Grace St Apt 206
  - 1025 W Grace St Apt 207
  - 1025 W Grace St Apt 1219
  - 1025 W Grace St Apt 122
  - 1025 W Grace St Apt 1220
  - 1025 W Grace St Apt 211
  - 1025 W Grace St Apt 212
  - 1025 W Grace St Apt 213
  - 1025 W Grace St Apt 202
  - 1025 W Grace St Apt 203
  - 1025 W Grace St Apt 204
  - 1025 W Grace St Apt 217
  - 1025 W Grace St Apt 218
  - 1025 W Grace St Apt 219
  - 1025 W Grace St Apt 208
  - 1025 W Grace St Apt 209
  - 1025 W Grace St Apt 210
  - 1025 W Grace St Apt 301
  - 1025 W Grace St Apt 302
  - 1025 W Grace St Apt 303
  - 1025 W Grace St Apt 214
  - 1025 W Grace St Apt 215
  - 1025 W Grace St Apt 216
  - 1025 W Grace St Apt 307
  - 1025 W Grace St Apt 308
  - 1025 W Grace St Apt 309
  - 1025 W Grace St Apt 220
  - 1025 W Grace St Apt 221
  - 1025 W Grace St Apt 222
  - 1025 W Grace St Apt 313
  - 1025 W Grace St Apt 314
  - 1025 W Grace St Apt 315
  - 1025 W Grace St Apt 304
  - 1025 W Grace St Apt 305
  - 1025 W Grace St Apt 306
  - 1025 W Grace St Apt 319
  - 1025 W Grace St Apt 320
  - 1025 W Grace St Apt 321
  - 1025 W Grace St Apt 310
  - 1025 W Grace St Apt 311
  - 1025 W Grace St Apt 312
  - 1025 W Grace St Apt 403
  - 1025 W Grace St Apt 404
  - 1025 W Grace St Apt 405
  - 1025 W Grace St Apt 316
  - 1025 W Grace St Apt 317
  - 1025 W Grace St Apt 318
  - 1025 W Grace St Apt 409
  - 1025 W Grace St Apt 410
  - 1025 W Grace St Apt 411
  - 1025 W Grace St Apt 322
  - 1025 W Grace St Apt 401
  - 1025 W Grace St Apt 402
  - 1025 W Grace St Apt 415
  - 1025 W Grace St Apt 416
  - 1025 W Grace St Apt 417
  - 1025 W Grace St Apt 406
  - 1025 W Grace St Apt 407
  - 1025 W Grace St Apt 408
  - 1025 W Grace St Apt 421
  - 1025 W Grace St Apt 422
  - 1025 W Grace St Apt 501
  - 1025 W Grace St Apt 412
  - 1025 W Grace St Apt 413
  - 1025 W Grace St Apt 414
  - 1025 W Grace St Apt 505
  - 1025 W Grace St Apt 506
  - 1025 W Grace St Apt 507
  - 1025 W Grace St Apt 418
  - 1025 W Grace St Apt 419
  - 1025 W Grace St Apt 420
  - 1025 W Grace St Apt 511
  - 1025 W Grace St Apt 512
  - 1025 W Grace St Apt 513
  - 1025 W Grace St Apt 502
  - 1025 W Grace St Apt 503
  - 1025 W Grace St Apt 504
  - 1025 W Grace St Apt 517
  - 1025 W Grace St Apt 518
  - 1025 W Grace St Apt 519
  - 1025 W Grace St Apt 508
  - 1025 W Grace St Apt 509
  - 1025 W Grace St Apt 510
  - 1025 W Grace St Apt 601
  - 1025 W Grace St Apt 602
  - 1025 W Grace St Apt 603
  - 1025 W Grace St Apt 514
  - 1025 W Grace St Apt 515
  - 1025 W Grace St Apt 516
  - 1025 W Grace St Apt 607
  - 1025 W Grace St Apt 608
  - 1025 W Grace St Apt 609
  - 1025 W Grace St Apt 520
  - 1025 W Grace St Apt 521
  - 1025 W Grace St Apt 522
  - 1025 W Grace St Apt 613
  - 1025 W Grace St Apt 614
  - 1025 W Grace St Apt 615
  - 1025 W Grace St Apt 604
  - 1025 W Grace St Apt 605
  - 1025 W Grace St Apt 606
  - 1025 W Grace St Apt 619
  - 1025 W Grace St Apt 620
  - 1025 W Grace St Apt 621
  - 1025 W Grace St Apt 610
  - 1025 W Grace St Apt 611
  - 1025 W Grace St Apt 612
  - 1025 W Grace St Apt 703
  - 1025 W Grace St Apt 704
  - 1025 W Grace St Apt 705
  - 1025 W Grace St Apt 616
  - 1025 W Grace St Apt 617
  - 1025 W Grace St Apt 618
  - 1025 W Grace St Apt 709
  - 1025 W Grace St Apt 710
  - 1025 W Grace St Apt 711
  - 1025 W Grace St Apt 622
  - 1025 W Grace St Apt 701
  - 1025 W Grace St Apt 702
  - 1025 W Grace St Apt 715
  - 1025 W Grace St Apt 716
  - 1025 W Grace St Apt 717
  - 1025 W Grace St Apt 706
  - 1025 W Grace St Apt 707
  - 1025 W Grace St Apt 708
  - 1025 W Grace St Apt 721
  - 1025 W Grace St Apt 722
  - 1025 W Grace St Apt 801
  - 1025 W Grace St Apt 712
  - 1025 W Grace St Apt 713
  - 1025 W Grace St Apt 714
  - 1025 W Grace St Apt 805
  - 1025 W Grace St Apt 806
  - 1025 W Grace St Apt 807
  - 1025 W Grace St Apt 718
  - 1025 W Grace St Apt 719
  - 1025 W Grace St Apt 720
  - 1025 W Grace St Apt 811
  - 1025 W Grace St Apt 812
  - 1025 W Grace St Apt 813
  - 1025 W Grace St Apt 802
  - 1025 W Grace St Apt 803
  - 1025 W Grace St Apt 804
  - 1025 W Grace St Apt 817
  - 1025 W Grace St Apt 818
  - 1025 W Grace St Apt 819
  - 1025 W Grace St Apt 808
  - 1025 W Grace St Apt 809
  - 1025 W Grace St Apt 810
  - 1025 W Grace St Apt 901
  - 1025 W Grace St Apt 902
  - 1025 W Grace St Apt 903
  - 1025 W Grace St Apt 814
  - 1025 W Grace St Apt 815
  - 1025 W Grace St Apt 816
  - 1025 W Grace St Apt 907
  - 1025 W Grace St Apt 908
  - 1025 W Grace St Apt 909
  - 1025 W Grace St Apt 820
  - 1025 W Grace St Apt 821
  - 1025 W Grace St Apt 822
  - 1025 W Grace St Apt 913
  - 1025 W Grace St Apt 914
  - 1025 W Grace St Apt 915
  - 1025 W Grace St Apt 904
  - 1025 W Grace St Apt 905
  - 1025 W Grace St Apt 906
  - 1025 W Grace St Apt 919
  - 1025 W Grace St Apt 920
  - 1025 W Grace St Apt 921
  - 1025 W Grace St Apt 910
  - 1025 W Grace St Apt 911
  - 1025 W Grace St Apt 912
----------------------------------------
Parcel Index: 293.0
Address Count: 2
Addresses:
  - 1918 Grove Ave Apt 1
  - 1918 Grove Ave Apt 2
----------------------------------------</code></pre>
</div>
</div>
</section>
</section>
<section id="available-columns" class="level2">
<h2 class="anchored" data-anchor-id="available-columns">Available columns</h2>
<div class="columns">
<div class="column" style="width:33%;">
<section id="civic_associations" class="level3">
<h3 class="anchored" data-anchor-id="civic_associations">Civic_Associations</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Property</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ID</td>
</tr>
<tr class="even">
<td>Name</td>
</tr>
<tr class="odd">
<td>AdoptionDate</td>
</tr>
<tr class="even">
<td>ChangeDate</td>
</tr>
<tr class="odd">
<td>GlobalID</td>
</tr>
<tr class="even">
<td>Shape__Area</td>
</tr>
<tr class="odd">
<td>Shape__Length</td>
</tr>
<tr class="even">
<td>geometry</td>
</tr>
</tbody>
</table>
</section>
</div><div class="column" style="width:33%;">
<section id="addresses_in_fan" class="level3">
<h3 class="anchored" data-anchor-id="addresses_in_fan">Addresses_in_fan</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Property</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AddressId</td>
</tr>
<tr class="even">
<td>AddressLabel</td>
</tr>
<tr class="odd">
<td>BuildingNumber</td>
</tr>
<tr class="even">
<td>StreetDirection</td>
</tr>
<tr class="odd">
<td>StreetName</td>
</tr>
<tr class="even">
<td>StreetType</td>
</tr>
<tr class="odd">
<td>ExtensionWithUnit</td>
</tr>
<tr class="even">
<td>UnitType</td>
</tr>
<tr class="odd">
<td>UnitValue</td>
</tr>
<tr class="even">
<td>ZipCode</td>
</tr>
<tr class="odd">
<td>Mailable</td>
</tr>
<tr class="even">
<td>StatePlaneX</td>
</tr>
<tr class="odd">
<td>StatePlaneY</td>
</tr>
<tr class="even">
<td>Latitude</td>
</tr>
<tr class="odd">
<td>Longitude</td>
</tr>
<tr class="even">
<td>geometry</td>
</tr>
<tr class="odd">
<td>ID</td>
</tr>
<tr class="even">
<td>Name</td>
</tr>
<tr class="odd">
<td>GlobalID</td>
</tr>
<tr class="even">
<td>Shape__Area</td>
</tr>
<tr class="odd">
<td>Shape__Length</td>
</tr>
<tr class="even">
<td>BaseAddressLabel</td>
</tr>
<tr class="odd">
<td>UnitCount</td>
</tr>
</tbody>
</table>
</section>
</div><div class="column" style="width:33%;">
<section id="parcels_in_fan" class="level3">
<h3 class="anchored" data-anchor-id="parcels_in_fan">Parcels_in_fan</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Property</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ParcelID</td>
</tr>
<tr class="even">
<td>PIN</td>
</tr>
<tr class="odd">
<td>CountOfPIN</td>
</tr>
<tr class="even">
<td>OwnerName</td>
</tr>
<tr class="odd">
<td>AsrLocationBldgNo</td>
</tr>
<tr class="even">
<td>MailAddress</td>
</tr>
<tr class="odd">
<td>MailCity</td>
</tr>
<tr class="even">
<td>MailState</td>
</tr>
<tr class="odd">
<td>MailZip</td>
</tr>
<tr class="even">
<td>AssessmentDate</td>
</tr>
<tr class="odd">
<td>LandValue</td>
</tr>
<tr class="even">
<td>DwellingValue</td>
</tr>
<tr class="odd">
<td>TotalValue</td>
</tr>
<tr class="even">
<td>LandSqFt</td>
</tr>
<tr class="odd">
<td>ProvalAsmtNhood</td>
</tr>
<tr class="even">
<td>TaxExemptCode</td>
</tr>
<tr class="odd">
<td>PropertyClassID</td>
</tr>
<tr class="even">
<td>PropertyClass</td>
</tr>
<tr class="odd">
<td>LandUse</td>
</tr>
<tr class="even">
<td>Mailable</td>
</tr>
<tr class="odd">
<td>MaskedOwner</td>
</tr>
<tr class="even">
<td>GlobalID_left</td>
</tr>
<tr class="odd">
<td>geometry</td>
</tr>
<tr class="even">
<td>ID</td>
</tr>
<tr class="odd">
<td>Name</td>
</tr>
<tr class="even">
<td>GlobalID_right</td>
</tr>
<tr class="odd">
<td>Shape__Area</td>
</tr>
<tr class="even">
<td>Shape__Length</td>
</tr>
<tr class="odd">
<td>geom_wkt</td>
</tr>
<tr class="even">
<td>geom_count</td>
</tr>
<tr class="odd">
<td>AddressList</td>
</tr>
<tr class="even">
<td>AddressIdList</td>
</tr>
</tbody>
</table>
</section>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Fan District Association</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>The City of Richmond maintains an arcgis geodata repository called <span class="co">[</span><span class="ot">Richmond GeoHub</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com)</span>.</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>Data on the geohub are organized into key areas.  For our analysis, we'll be using the </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>following data sources.</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Addresses</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/674d645c444f4191998f0ebb96e56047_0/explore?location=37.527383%2C-77.493413%2C10.99)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>: All of the official, mapped inventory of all unit and non-unit-based addresses in the City. Includes only active addresses.</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Parcels</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/fbfce2aab2a44c05bc0abc2d6ea7e54a_0/explore?location=37.525465%2C-77.493422%2C10.60)</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>: City of Richmond property ownership information, mapped by land ownership (parcels).</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Civic Associations</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/be39ce592f3e4419babe11d1b967e2f3_0/explore?location=37.528836%2C-77.494197%2C10.96)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>: Represents civic organization boundaries in the city of Richmond, Virginia.</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">National Historic Districts</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/38bd0df47c6440528c2ef22daaf81883_0/explore?location=37.550339%2C-77.468606%2C14.93)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>: Represents districts and sites that are listed on the National Register of Historic Places (Federal designation) and the Virginia Landmarks Register (State designation).</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Neighborhoods</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/7a0ffef23d16461e9728c065f27b2790_0/explore?location=37.525021%2C-77.493427%2C10.73)</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>: City of Richmond Neighborhoods.</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>For our Fan District analysis we will be working with <span class="co">[</span><span class="ot">Civic Associations</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/be39ce592f3e4419babe11d1b967e2f3_0/explore?location=37.528836%2C-77.494197%2C10.96)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>to get the formal boundary of the *Fan District Association*.</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>We then use that boundary to determine <span class="co">[</span><span class="ot">Addresses</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/674d645c444f4191998f0ebb96e56047_0/explore?location=37.527383%2C-77.493413%2C10.99)</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>and <span class="co">[</span><span class="ot">Parcels</span><span class="co">](https://richmond-geo-hub-cor.hub.arcgis.com/datasets/fbfce2aab2a44c05bc0abc2d6ea7e54a_0/explore?location=37.525465%2C-77.493422%2C10.60)</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>in the *Fan District Association*</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> floor</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> loguru <span class="im">import</span> logger</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">".."</span>)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fandu.geo_utils <span class="im">import</span> get_newest_feature_file</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_rows"</span>, <span class="va">None</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>geojson_folder <span class="op">=</span> <span class="st">"../precious/"</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [<span class="st">"Addresses"</span>,<span class="st">"Parcels"</span>]</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>selector <span class="op">=</span> <span class="st">"Civic_Associations"</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>selector_key <span class="op">=</span> <span class="st">"Fan District Association"</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fan District Association</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the neighborhoods GeoJSON</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> [selector] <span class="op">+</span> features:</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    geofile <span class="op">=</span> get_newest_feature_file( geojson_folder, feature )</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">#logger.debug(geofile)</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">:  </span><span class="sc">{</span>geofile<span class="sc">}</span><span class="ss">"</span> )</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    data[feature] <span class="op">=</span> gpd.read_file( geofile )</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    data[feature] <span class="op">=</span> data[feature].to_crs( data[selector].crs )</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a><span class="co"># columns to drop:</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>shared_drops <span class="op">=</span> [<span class="st">'CreatedBy'</span>,<span class="st">'CreatedDate'</span>,<span class="st">'EditBy'</span>,<span class="st">'EditDate'</span>]</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>drop_columns <span class="op">=</span> {</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Civic_Associations"</span> : [<span class="st">'OBJECTID'</span>] <span class="op">+</span> shared_drops,</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Addresses"</span>          : [<span class="st">'OBJECTID'</span>] <span class="op">+</span> shared_drops,</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Parcels"</span>            : [<span class="st">'OBJECTID'</span>],</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> [selector] <span class="op">+</span> features:</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>    data[feature] <span class="op">=</span> data[feature].drop(columns<span class="op">=</span>drop_columns[feature])</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    data[selector_key] <span class="op">=</span> data[selector][ data[selector][<span class="st">"Name"</span>] <span class="op">==</span> selector_key ]</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    predicate <span class="op">=</span> <span class="st">"overlaps"</span> <span class="cf">if</span> feature<span class="op">==</span><span class="st">"Neighborhoods"</span> <span class="cf">else</span> <span class="st">"within"</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>    data[feature<span class="op">+</span><span class="st">"_in_fan"</span>] <span class="op">=</span> gpd.sjoin(data[feature], data[selector_key], predicate<span class="op">=</span>predicate, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> feature<span class="op">+</span><span class="st">"_in_fan"</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>    data[feature_name] <span class="op">=</span> data[feature_name].drop(columns<span class="op">=</span>[<span class="st">"index_right"</span>,<span class="st">"AdoptionDate"</span>,<span class="st">"ChangeDate"</span>])</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    feature_name <span class="op">=</span> feature<span class="op">+</span><span class="st">"_in_fan"</span></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data[feature_name].drop(columns<span class="op">=</span><span class="st">"geometry"</span>)</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    df.to_csv(<span class="ss">f"</span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss">.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving: </span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss">.csv"</span> )</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## FDA - Key measures</span></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a><span class="fu">### Area </span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the Shape_Area value for the row where Name == selector_key</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>projected <span class="op">=</span> data[selector].to_crs(epsg<span class="op">=</span><span class="dv">2283</span>)</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Get Shape_Area for the selected feature</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>area_sqft <span class="op">=</span> projected.loc[projected[<span class="st">"Name"</span>] <span class="op">==</span> selector_key, <span class="st">"geometry"</span>].area.iloc[<span class="dv">0</span>]</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to acres</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>area_acres <span class="op">=</span> area_sqft <span class="op">/</span> <span class="dv">43560</span></span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>area_sqmi <span class="op">=</span> area_sqft <span class="op">/</span> <span class="dv">27_878_400</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>area_sqm <span class="op">=</span> area_sqft <span class="op">*</span> <span class="fl">0.09290304</span></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>area_hectare <span class="op">=</span> area_sqm <span class="op">/</span> <span class="dv">10_000</span></span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>area_sqkm <span class="op">=</span> area_sqm <span class="op">/</span> <span class="dv">1_000_000</span></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>selector_key<span class="sc">}</span><span class="ss">: Area: </span><span class="sc">{</span>area_sqft<span class="sc">:,.0f}</span><span class="ss"> sq.ft.,  </span><span class="sc">{</span>area_acres<span class="sc">:,.2f}</span><span class="ss"> acres, </span><span class="sc">{</span>area_sqmi<span class="sc">:,.3f}</span><span class="ss"> sq.miles"</span>)</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>selector_key<span class="sc">}</span><span class="ss">: Area: </span><span class="sc">{</span>area_sqm<span class="sc">:,.0f}</span><span class="ss"> sq.m, </span><span class="sc">{</span>area_hectare<span class="sc">:,.3f}</span><span class="ss"> hectares, </span><span class="sc">{</span>area_sqkm<span class="sc">:,.3f}</span><span class="ss"> sq.km"</span>)</span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### Examples of records sharing the same AddressLabel</span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name]</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Find duplicated AddressLabels</span></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>duplicates <span class="op">=</span> gdf[gdf.duplicated(subset<span class="op">=</span>[<span class="st">"AddressLabel"</span>], keep<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Group and inspect (optional)</span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> duplicates.sort_values(<span class="st">"AddressLabel"</span>).groupby(<span class="st">"AddressLabel"</span>)</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Print summary</span></span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total duplicated AddressLabel records: </span><span class="sc">{</span><span class="bu">len</span>(duplicates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of unique duplicated labels: </span><span class="sc">{</span>duplicates[<span class="st">'AddressLabel'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Show some examples</span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Examples of duplicated AddressLabels:"</span>)</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(duplicates[[<span class="st">"AddressLabel"</span>, <span class="st">"UnitType"</span>, <span class="st">"UnitValue"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a><span class="fu">### Examples of non-unit addresses with unit parts in AddressLabel</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name].copy()</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Build a list of distinct, non-null UnitTypes</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>potential_unit_types <span class="op">=</span> gdf[<span class="st">"UnitType"</span>].dropna().astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().unique().tolist()</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a>potential_unit_types <span class="op">=</span> [ut <span class="cf">for</span> ut <span class="kw">in</span> potential_unit_types <span class="cf">if</span> ut]  <span class="co"># Remove blanks</span></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Build regex pattern to match unit suffix at end of address</span></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a><span class="co">#unit_pattern = r"\b(" + "|".join(map(re.escape, potential_unit_types)) + r")\s+\S+$"</span></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a>unit_pattern <span class="op">=</span> <span class="vs">r"</span><span class="dv">\b</span>(?:<span class="vs">{}</span>)<span class="dv">\s</span><span class="op">+</span><span class="dv">\S</span><span class="op">+</span><span class="dv">$</span><span class="vs">"</span>.<span class="bu">format</span>(<span class="st">"|"</span>.join(<span class="bu">map</span>(re.escape, potential_unit_types)))</span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Find rows with UnitType == None and AddressLabel contains a recognizable UnitType</span></span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> gdf[<span class="st">"UnitType"</span>].isnull() <span class="op">&amp;</span> gdf[<span class="st">"AddressLabel"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.contains(unit_pattern, regex<span class="op">=</span><span class="va">True</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset matching rows</span></span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a>candidates <span class="op">=</span> gdf[mask].copy()</span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Report</span></span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üîç Found </span><span class="sc">{</span><span class="bu">len</span>(candidates)<span class="sc">}</span><span class="ss"> rows where AddressLabel ends with a recognizable UnitType + value and UnitType is missing."</span>)</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">üß™ Sample rows:"</span>)</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(candidates[[<span class="st">"AddressLabel"</span>, <span class="st">"UnitType"</span>, <span class="st">"UnitValue"</span>]].head())</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fix these issues found above.</span></span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Extract UnitType and UnitValue using regex</span></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Example match: "501 N Arthur Ashe Blvd Unit 2" ‚Üí ("Unit", "2")</span></span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a>unit_extract_pattern <span class="op">=</span> <span class="vs">r"</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">"</span> <span class="op">+</span> <span class="st">"|"</span>.join(<span class="bu">map</span>(re.escape, potential_unit_types)) <span class="op">+</span> <span class="vs">r"</span><span class="er">)</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="dv">\S</span><span class="op">+</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>unit_parts <span class="op">=</span> candidates[<span class="st">"AddressLabel"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.extract(unit_extract_pattern)</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign back to the original gdf using index alignment</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>gdf.loc[candidates.index, <span class="st">"UnitType"</span>] <span class="op">=</span> unit_parts[<span class="dv">0</span>]</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>gdf.loc[candidates.index, <span class="st">"UnitValue"</span>] <span class="op">=</span> unit_parts[<span class="dv">1</span>]</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Update data structure</span></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a>data[feature_name] <span class="op">=</span> gdf</span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">‚úÖ Extracted UnitType and UnitValue for </span><span class="sc">{</span><span class="bu">len</span>(unit_parts.dropna())<span class="sc">}</span><span class="ss"> rows."</span>)</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a><span class="fu">### Examples of non-unit addreses sharing the same long/lat</span></span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name]</span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Filter for base addresses (UnitType is None) and valid coordinates</span></span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>base_addrs <span class="op">=</span> gdf[</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"UnitType"</span>].isnull() <span class="op">&amp;</span></span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"Longitude"</span>].notnull() <span class="op">&amp;</span></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"Latitude"</span>].notnull()</span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Find duplicate coordinate records</span></span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a>dup_coords <span class="op">=</span> base_addrs[</span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a>    base_addrs.duplicated(subset<span class="op">=</span>[<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>], keep<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Group duplicates for inspection</span></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a>coord_groups <span class="op">=</span> dup_coords.groupby([<span class="st">"Latitude"</span>, <span class="st">"Longitude"</span>])</span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Summary counts</span></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üìç Total base address rows with duplicate coordinates: </span><span class="sc">{</span><span class="bu">len</span>(dup_coords)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üîÅ Unique (lat, lon) pairs with duplicates: </span><span class="sc">{</span>coord_groups<span class="sc">.</span>ngroups<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Show sample groups</span></span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">üîç Example duplicates (UnitType is None, by lat/lon):"</span>)</span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (lat, lon), group <span class="kw">in</span> coord_groups:</span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Coordinates: (</span><span class="sc">{</span>lat<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lon<span class="sc">}</span><span class="ss">) ‚Äî </span><span class="sc">{</span><span class="bu">len</span>(group)<span class="sc">}</span><span class="ss"> records"</span>)</span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a>    sorted_group <span class="op">=</span> group.sort_values(<span class="st">"AddressLabel"</span>)</span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(sorted_group[[<span class="st">"AddressLabel"</span>, <span class="st">"UnitType"</span>, <span class="st">"UnitValue"</span>, <span class="st">"Latitude"</span>, <span class="st">"Longitude"</span>]])</span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span>  <span class="co"># Remove this if you want to show all groups</span></span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="dv">0</span>:</span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n\n</span><span class="st">üîç First record from each duplicate (UnitType is None, by lat/lon):"</span>)</span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (lat, lon), group <span class="kw">in</span> coord_groups:</span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a>        first <span class="op">=</span> group.sort_values(<span class="st">"AddressLabel"</span>).iloc[<span class="dv">0</span>]</span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>first[<span class="st">'AddressLabel'</span>]<span class="sc">}</span><span class="ss"> | UnitType=</span><span class="sc">{</span>first[<span class="st">'UnitType'</span>]<span class="sc">}</span><span class="ss"> | UnitValue=</span><span class="sc">{</span>first[<span class="st">'UnitValue'</span>]<span class="sc">}</span><span class="ss"> | (</span><span class="sc">{</span>lat<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lon<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">üîç First record from each duplicate (UnitType is None, by lat/lon):"</span>)</span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (lat, lon), group <span class="kw">in</span> coord_groups:</span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a>    first <span class="op">=</span> group.sort_values(<span class="st">"AddressLabel"</span>).iloc[<span class="dv">0</span>]</span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a>    group_size <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>first[<span class="st">'AddressLabel'</span>]<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>group_size<span class="sc">}</span><span class="ss"> records | (</span><span class="sc">{</span>lat<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lon<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fix: jitter addresses</span></span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a copy so we can safely modify coordinates</span></span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a>gdf_jittered <span class="op">=</span> gdf.copy()</span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Define base jitter radius in degrees (very small ~meters)</span></span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a>base_radius_deg <span class="op">=</span> <span class="fl">0.00001</span></span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over each group</span></span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (lat, lon), group <span class="kw">in</span> coord_groups:</span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>  <span class="co"># No need to jitter</span></span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a>    radius <span class="op">=</span> base_radius_deg <span class="op">*</span> np.sqrt(<span class="fl">1.0</span> <span class="op">*</span> count)  <span class="co"># Increase radius with count</span></span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a>     <span class="co"># One random multiplier [0, 1) for each point</span></span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a>    random_scalars <span class="op">=</span> np.random.rand(count)</span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final radius for each point</span></span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a>    radii <span class="op">=</span> radius <span class="op">*</span> random_scalars</span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>    angles <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, count, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a>    jittered_lats <span class="op">=</span> lat <span class="op">+</span> radii <span class="op">*</span> np.sin(angles)</span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a>    jittered_lons <span class="op">=</span> lon <span class="op">+</span> radii <span class="op">*</span> np.cos(angles)</span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign jittered coordinates back using index</span></span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a>    gdf_jittered.loc[group.index, <span class="st">"Latitude"</span>] <span class="op">=</span> jittered_lats</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a>    gdf_jittered.loc[group.index, <span class="st">"Longitude"</span>] <span class="op">=</span> jittered_lons</span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a>data[feature_name].loc[gdf_jittered.index, <span class="st">"Latitude"</span>] <span class="op">=</span> gdf_jittered[<span class="st">"Latitude"</span>]</span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a>data[feature_name].loc[gdf_jittered.index, <span class="st">"Longitude"</span>] <span class="op">=</span> gdf_jittered[<span class="st">"Longitude"</span>]</span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Update all the geometries</span></span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a>data[feature_name][<span class="st">"geometry"</span>] <span class="op">=</span> data[feature_name].<span class="bu">apply</span>(</span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: Point(row[<span class="st">"Longitude"</span>], row[<span class="st">"Latitude"</span>]), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"‚úÖ Jittered coordinates applied to duplicate lat/lon groups."</span>)</span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: Unit addresses without non-unit base address</span></span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name]</span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Get unit addresses (where UnitType is not null)</span></span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a>unit_addrs <span class="op">=</span> gdf[gdf[<span class="st">"UnitType"</span>].notnull()].copy()</span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Extract base address (remove unit from AddressLabel)</span></span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Assumes unit info appears after a comma, e.g., "123 Main St, Apt 2B"</span></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a>unit_addrs[<span class="st">"BaseAddressLabel"</span>] <span class="op">=</span> (</span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a>    unit_addrs[<span class="st">"BuildingNumber"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a>    unit_addrs[<span class="st">"StreetDirection"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-334"><a href="#cb19-334" aria-hidden="true" tabindex="-1"></a>    unit_addrs[<span class="st">"StreetName"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-335"><a href="#cb19-335" aria-hidden="true" tabindex="-1"></a>    unit_addrs[<span class="st">"StreetType"</span>].fillna(<span class="st">""</span>)</span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a>).<span class="bu">str</span>.replace(<span class="vs">r"</span><span class="dv">\s</span><span class="op">+</span><span class="vs">"</span>, <span class="st">" "</span>, regex<span class="op">=</span><span class="va">True</span>).<span class="bu">str</span>.strip()</span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Get base addresses in the dataset (with UnitType == None)</span></span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a>base_addrs <span class="op">=</span> gdf[gdf[<span class="st">"UnitType"</span>].isnull()].copy()</span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a>base_addrs[<span class="st">"BaseAddressLabel"</span>] <span class="op">=</span> (</span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a>    base_addrs[<span class="st">"BuildingNumber"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a>    base_addrs[<span class="st">"StreetDirection"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a>    base_addrs[<span class="st">"StreetName"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a>    base_addrs[<span class="st">"StreetType"</span>].fillna(<span class="st">""</span>)</span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a>).<span class="bu">str</span>.strip().replace(<span class="vs">r"</span><span class="dv">\s</span><span class="op">+</span><span class="vs">"</span>, <span class="st">" "</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a>base_addrs[<span class="st">"AddressLabel"</span>] <span class="op">=</span> base_addrs[<span class="st">"AddressLabel"</span>].fillna(<span class="st">""</span>).astype(<span class="bu">str</span>).<span class="bu">str</span>.strip()</span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Get the set of base labels from base_addrs</span></span>
<span id="cb19-350"><a href="#cb19-350" aria-hidden="true" tabindex="-1"></a>base_set <span class="op">=</span> <span class="bu">set</span>(base_addrs[<span class="st">"BaseAddressLabel"</span>])</span>
<span id="cb19-351"><a href="#cb19-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Find unit addresses whose base is missing</span></span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> unit_addrs[<span class="op">~</span>unit_addrs[<span class="st">"BaseAddressLabel"</span>].isin(base_set)]</span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Print summary</span></span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total unit addresses: </span><span class="sc">{</span><span class="bu">len</span>(unit_addrs)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unit addresses with missing base address: </span><span class="sc">{</span><span class="bu">len</span>(missing)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> missing.empty:</span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Examples of missing base addresses:"</span>)</span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(missing[[<span class="st">"AddressLabel"</span>, <span class="st">"BaseAddressLabel"</span>, <span class="st">"UnitType"</span>, <span class="st">"UnitValue"</span>]].head())</span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-363"><a href="#cb19-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-364"><a href="#cb19-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a><span class="fu">### List of non-unit addresses where baseaddresslabel &lt;&gt; addressLabel</span></span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a><span class="co"># Count total base records</span></span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a>total_base <span class="op">=</span> <span class="bu">len</span>(base_addrs)</span>
<span id="cb19-372"><a href="#cb19-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-373"><a href="#cb19-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare BaseAddressLabel to AddressLabel</span></span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a>match <span class="op">=</span> base_addrs[base_addrs[<span class="st">"BaseAddressLabel"</span>] <span class="op">==</span> base_addrs[<span class="st">"AddressLabel"</span>]]</span>
<span id="cb19-375"><a href="#cb19-375" aria-hidden="true" tabindex="-1"></a>mismatch <span class="op">=</span> base_addrs[base_addrs[<span class="st">"BaseAddressLabel"</span>] <span class="op">!=</span> base_addrs[<span class="st">"AddressLabel"</span>]]</span>
<span id="cb19-376"><a href="#cb19-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Print counts</span></span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total base addresses (UnitType is null): </span><span class="sc">{</span>total_base<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Matching AddressLabel == BaseAddressLabel: </span><span class="sc">{</span><span class="bu">len</span>(match)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Non-matching AddressLabel != BaseAddressLabel: </span><span class="sc">{</span><span class="bu">len</span>(mismatch)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Show examples of mismatches</span></span>
<span id="cb19-383"><a href="#cb19-383" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> mismatch.empty:</span>
<span id="cb19-384"><a href="#cb19-384" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Examples of mismatched base addresses:"</span>)</span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mismatch[[<span class="st">"AddressLabel"</span>, <span class="st">"BaseAddressLabel"</span>]].head())</span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a><span class="fu">### Addresses with the top 20 unit counts.</span></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name].copy()</span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create BaseAddressLabel for all addresses</span></span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a>gdf[<span class="st">"BaseAddressLabel"</span>] <span class="op">=</span> (</span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"BuildingNumber"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"StreetDirection"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"StreetName"</span>].fillna(<span class="st">""</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"StreetType"</span>].fillna(<span class="st">""</span>)</span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a>).<span class="bu">str</span>.strip().replace(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Count number of unit addresses per BaseAddressLabel</span></span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a>unit_counts <span class="op">=</span> (</span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a>    gdf[gdf[<span class="st">"UnitType"</span>].notnull()]</span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"BaseAddressLabel"</span>)</span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb19-410"><a href="#cb19-410" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"UnitCountForBase"</span>)</span>
<span id="cb19-411"><a href="#cb19-411" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Map unit counts to base addresses</span></span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a>gdf[<span class="st">"UnitCount"</span>] <span class="op">=</span> gdf[<span class="st">"BaseAddressLabel"</span>].<span class="bu">map</span>(unit_counts).fillna(<span class="dv">1</span>).astype(<span class="bu">int</span>)</span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Save back to data object</span></span>
<span id="cb19-417"><a href="#cb19-417" aria-hidden="true" tabindex="-1"></a>data[feature_name] <span class="op">=</span> gdf</span>
<span id="cb19-418"><a href="#cb19-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">"Addresses_in_fan"</span></span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[feature_name]</span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by UnitCount descending and drop duplicates to avoid listing each unit individually</span></span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a>top_bases <span class="op">=</span> (</span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a>    gdf[gdf[<span class="st">"UnitType"</span>].isnull()]  <span class="co"># Only base addresses</span></span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"UnitCount"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">20</span>)</span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Display relevant info</span></span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top_bases[[<span class="st">"AddressLabel"</span>, <span class="st">"BaseAddressLabel"</span>, <span class="st">"UnitCount"</span>,<span class="st">"UnitType"</span>]])</span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a><span class="fu">### Delete parcels with duplicate geometries</span></span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your GeoDataFrame</span></span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>]</span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert geometries to a hashable form for comparison</span></span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a>gdf[<span class="st">"geom_wkt"</span>] <span class="op">=</span> gdf.geometry.to_wkt()</span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-452"><a href="#cb19-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only the first occurrence of each geometry</span></span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a>gdf_unique <span class="op">=</span> gdf.drop_duplicates(subset<span class="op">=</span><span class="st">"geom_wkt"</span>, keep<span class="op">=</span><span class="st">"first"</span>).copy()</span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the helper column</span></span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a>gdf_unique.drop(columns<span class="op">=</span>[<span class="st">"geom_wkt"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"Parcels_in_fan"</span>] <span class="op">=</span> gdf_unique</span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a><span class="co"># Or inspect</span></span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Original count: </span><span class="sc">{</span><span class="bu">len</span>(gdf)<span class="sc">}</span><span class="ss">, After deduplication: </span><span class="sc">{</span><span class="bu">len</span>(gdf_unique)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a>List out duplicate parcels</span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-469"><a href="#cb19-469" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-470"><a href="#cb19-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Load your parcel GeoDataFrame</span></span>
<span id="cb19-471"><a href="#cb19-471" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>]</span>
<span id="cb19-472"><a href="#cb19-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-473"><a href="#cb19-473" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Convert geometry to WKT for exact-match comparison</span></span>
<span id="cb19-474"><a href="#cb19-474" aria-hidden="true" tabindex="-1"></a>gdf[<span class="st">"geom_wkt"</span>] <span class="op">=</span> gdf.geometry.to_wkt()</span>
<span id="cb19-475"><a href="#cb19-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-476"><a href="#cb19-476" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Count duplicate geometries</span></span>
<span id="cb19-477"><a href="#cb19-477" aria-hidden="true" tabindex="-1"></a>geom_counts <span class="op">=</span> gdf[<span class="st">"geom_wkt"</span>].value_counts()</span>
<span id="cb19-478"><a href="#cb19-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-479"><a href="#cb19-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Add back the count to the original GeoDataFrame</span></span>
<span id="cb19-480"><a href="#cb19-480" aria-hidden="true" tabindex="-1"></a>gdf[<span class="st">"geom_count"</span>] <span class="op">=</span> gdf[<span class="st">"geom_wkt"</span>].<span class="bu">map</span>(geom_counts)</span>
<span id="cb19-481"><a href="#cb19-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-482"><a href="#cb19-482" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5 (Optional): See only duplicates</span></span>
<span id="cb19-483"><a href="#cb19-483" aria-hidden="true" tabindex="-1"></a>duplicates <span class="op">=</span> gdf[gdf[<span class="st">"geom_count"</span>] <span class="op">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb19-484"><a href="#cb19-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-485"><a href="#cb19-485" aria-hidden="true" tabindex="-1"></a><span class="co"># Print or inspect</span></span>
<span id="cb19-486"><a href="#cb19-486" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(duplicates[[<span class="st">"ParcelID"</span>, <span class="st">"PIN"</span>, <span class="st">"geom_count"</span>]])</span>
<span id="cb19-487"><a href="#cb19-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-488"><a href="#cb19-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-489"><a href="#cb19-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-490"><a href="#cb19-490" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merge addresses to parcels</span></span>
<span id="cb19-491"><a href="#cb19-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-494"><a href="#cb19-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-495"><a href="#cb19-495" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-496"><a href="#cb19-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-497"><a href="#cb19-497" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Reproject to a common CRS if necessary</span></span>
<span id="cb19-498"><a href="#cb19-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-499"><a href="#cb19-499" aria-hidden="true" tabindex="-1"></a>parcels_gdf <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>]</span>
<span id="cb19-500"><a href="#cb19-500" aria-hidden="true" tabindex="-1"></a>addresses <span class="op">=</span> data[<span class="st">"Addresses_in_fan"</span>].to_crs(parcels_gdf.crs)</span>
<span id="cb19-501"><a href="#cb19-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-502"><a href="#cb19-502" aria-hidden="true" tabindex="-1"></a><span class="co"># üîç Filter to include only addresses with UnitType not null (unit addresses)</span></span>
<span id="cb19-503"><a href="#cb19-503" aria-hidden="true" tabindex="-1"></a>addresses <span class="op">=</span> addresses[addresses[<span class="st">"UnitType"</span>].notnull()]</span>
<span id="cb19-504"><a href="#cb19-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-505"><a href="#cb19-505" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Perform spatial join: which addresses fall within which parcel</span></span>
<span id="cb19-506"><a href="#cb19-506" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> gpd.sjoin(addresses, parcels_gdf, predicate<span class="op">=</span><span class="st">"within"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb19-507"><a href="#cb19-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-508"><a href="#cb19-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Group addresses by parcel index and aggregate</span></span>
<span id="cb19-509"><a href="#cb19-509" aria-hidden="true" tabindex="-1"></a>address_groups <span class="op">=</span> (</span>
<span id="cb19-510"><a href="#cb19-510" aria-hidden="true" tabindex="-1"></a>    joined.groupby(<span class="st">"index_right"</span>)</span>
<span id="cb19-511"><a href="#cb19-511" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb19-512"><a href="#cb19-512" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AddressLabel"</span>: <span class="kw">lambda</span> x: <span class="bu">list</span>(x.dropna()),</span>
<span id="cb19-513"><a href="#cb19-513" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AddressId"</span>: <span class="kw">lambda</span> x: <span class="bu">list</span>(x.dropna())</span>
<span id="cb19-514"><a href="#cb19-514" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-515"><a href="#cb19-515" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"AddressLabel"</span>: <span class="st">"AddressList"</span>, <span class="st">"AddressId"</span>: <span class="st">"AddressIdList"</span>})</span>
<span id="cb19-516"><a href="#cb19-516" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-517"><a href="#cb19-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-518"><a href="#cb19-518" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Merge back into parcels</span></span>
<span id="cb19-519"><a href="#cb19-519" aria-hidden="true" tabindex="-1"></a>parcels_with_addresses <span class="op">=</span> parcels_gdf.join(address_groups)</span>
<span id="cb19-520"><a href="#cb19-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-521"><a href="#cb19-521" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Fill missing lists as empty</span></span>
<span id="cb19-522"><a href="#cb19-522" aria-hidden="true" tabindex="-1"></a>parcels_with_addresses[<span class="st">"AddressList"</span>] <span class="op">=</span> parcels_with_addresses[<span class="st">"AddressList"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-523"><a href="#cb19-523" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb19-524"><a href="#cb19-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-525"><a href="#cb19-525" aria-hidden="true" tabindex="-1"></a>parcels_with_addresses[<span class="st">"AddressIdList"</span>] <span class="op">=</span> parcels_with_addresses[<span class="st">"AddressIdList"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-526"><a href="#cb19-526" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">list</span>) <span class="cf">else</span> []</span>
<span id="cb19-527"><a href="#cb19-527" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-528"><a href="#cb19-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-529"><a href="#cb19-529" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Store result back into data</span></span>
<span id="cb19-530"><a href="#cb19-530" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"Parcels_in_fan"</span>] <span class="op">=</span> parcels_with_addresses</span>
<span id="cb19-531"><a href="#cb19-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-532"><a href="#cb19-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-533"><a href="#cb19-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-534"><a href="#cb19-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### Frequency of addresses counts in parcels</span></span>
<span id="cb19-535"><a href="#cb19-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-538"><a href="#cb19-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-539"><a href="#cb19-539" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Get number of addresses per parcel</span></span>
<span id="cb19-540"><a href="#cb19-540" aria-hidden="true" tabindex="-1"></a>address_counts <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>][<span class="st">"AddressList"</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb19-541"><a href="#cb19-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-542"><a href="#cb19-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create frequency table</span></span>
<span id="cb19-543"><a href="#cb19-543" aria-hidden="true" tabindex="-1"></a>frequency_table <span class="op">=</span> address_counts.value_counts().sort_index()</span>
<span id="cb19-544"><a href="#cb19-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-545"><a href="#cb19-545" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Print result</span></span>
<span id="cb19-546"><a href="#cb19-546" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üìä Frequency of address counts per parcel:"</span>)</span>
<span id="cb19-547"><a href="#cb19-547" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(frequency_table)</span>
<span id="cb19-548"><a href="#cb19-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-549"><a href="#cb19-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-550"><a href="#cb19-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-551"><a href="#cb19-551" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why so many odd parcel counts?</span></span>
<span id="cb19-552"><a href="#cb19-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-553"><a href="#cb19-553" aria-hidden="true" tabindex="-1"></a>let's look at a few parcels with 12 addresses.</span>
<span id="cb19-554"><a href="#cb19-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-557"><a href="#cb19-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-558"><a href="#cb19-558" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Get parcels with exactly 12 addresses</span></span>
<span id="cb19-559"><a href="#cb19-559" aria-hidden="true" tabindex="-1"></a>parcels_with_12 <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>][data[<span class="st">"Parcels_in_fan"</span>][<span class="st">"AddressList"</span>].<span class="bu">apply</span>(<span class="bu">len</span>) <span class="op">==</span> <span class="dv">12</span>]</span>
<span id="cb19-560"><a href="#cb19-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-561"><a href="#cb19-561" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Display first few (e.g., 5) with their addresses</span></span>
<span id="cb19-562"><a href="#cb19-562" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üì¶ Parcels with exactly 12 addresses:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-563"><a href="#cb19-563" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> parcels_with_12.head(<span class="dv">5</span>).iterrows():</span>
<span id="cb19-564"><a href="#cb19-564" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Parcel Index: </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-565"><a href="#cb19-565" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Addresses:"</span>)</span>
<span id="cb19-566"><a href="#cb19-566" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> addr <span class="kw">in</span> row[<span class="st">"AddressList"</span>]:</span>
<span id="cb19-567"><a href="#cb19-567" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>addr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-568"><a href="#cb19-568" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb19-569"><a href="#cb19-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-570"><a href="#cb19-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-571"><a href="#cb19-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-572"><a href="#cb19-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-573"><a href="#cb19-573" aria-hidden="true" tabindex="-1"></a><span class="fu">### Any now digging into 2710 Stuart</span></span>
<span id="cb19-574"><a href="#cb19-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-577"><a href="#cb19-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-578"><a href="#cb19-578" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function: check if any address in the list starts with "2710 Stuart Ave"</span></span>
<span id="cb19-579"><a href="#cb19-579" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> has_stuart_ave(addresses):</span>
<span id="cb19-580"><a href="#cb19-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(addr.startswith(<span class="st">"2710 Stuart Ave"</span>) <span class="cf">for</span> addr <span class="kw">in</span> addresses)</span>
<span id="cb19-581"><a href="#cb19-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-582"><a href="#cb19-582" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Filter parcels with at least one address matching "2710 Stuart Ave"</span></span>
<span id="cb19-583"><a href="#cb19-583" aria-hidden="true" tabindex="-1"></a>stuart_parcels <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>][data[<span class="st">"Parcels_in_fan"</span>][<span class="st">"AddressList"</span>].<span class="bu">apply</span>(has_stuart_ave)]</span>
<span id="cb19-584"><a href="#cb19-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-585"><a href="#cb19-585" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Show full info for each parcel</span></span>
<span id="cb19-586"><a href="#cb19-586" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üì¶ Parcels containing addresses for '2710 Stuart Ave':</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-587"><a href="#cb19-587" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> stuart_parcels.iterrows():</span>
<span id="cb19-588"><a href="#cb19-588" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Parcel Index: </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-589"><a href="#cb19-589" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> row.items():</span>
<span id="cb19-590"><a href="#cb19-590" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>):</span>
<span id="cb19-591"><a href="#cb19-591" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb19-592"><a href="#cb19-592" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> value:</span>
<span id="cb19-593"><a href="#cb19-593" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>item<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-594"><a href="#cb19-594" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-595"><a href="#cb19-595" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-596"><a href="#cb19-596" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-597"><a href="#cb19-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-598"><a href="#cb19-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-599"><a href="#cb19-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-600"><a href="#cb19-600" aria-hidden="true" tabindex="-1"></a><span class="fu">### All the duplicate parcels</span></span>
<span id="cb19-601"><a href="#cb19-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-604"><a href="#cb19-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-605"><a href="#cb19-605" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-606"><a href="#cb19-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-607"><a href="#cb19-607" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="dv">0</span>:</span>
<span id="cb19-608"><a href="#cb19-608" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Normalize AddressList for comparison ‚Äî sort and convert to tuple</span></span>
<span id="cb19-609"><a href="#cb19-609" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalized_address_list(addresses):</span>
<span id="cb19-610"><a href="#cb19-610" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">tuple</span>(<span class="bu">sorted</span>(addresses)) <span class="cf">if</span> <span class="bu">isinstance</span>(addresses, <span class="bu">list</span>) <span class="cf">else</span> ()</span>
<span id="cb19-611"><a href="#cb19-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-612"><a href="#cb19-612" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Create a normalized column</span></span>
<span id="cb19-613"><a href="#cb19-613" aria-hidden="true" tabindex="-1"></a>    parcels <span class="op">=</span> data[<span class="st">"Parcels_in_fan"</span>].copy()</span>
<span id="cb19-614"><a href="#cb19-614" aria-hidden="true" tabindex="-1"></a>    parcels[<span class="st">"AddressListKey"</span>] <span class="op">=</span> parcels[<span class="st">"AddressList"</span>].<span class="bu">apply</span>(normalized_address_list)</span>
<span id="cb19-615"><a href="#cb19-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-616"><a href="#cb19-616" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Group by the normalized address list</span></span>
<span id="cb19-617"><a href="#cb19-617" aria-hidden="true" tabindex="-1"></a>    grouped <span class="op">=</span> parcels.groupby(<span class="st">"AddressListKey"</span>)</span>
<span id="cb19-618"><a href="#cb19-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-619"><a href="#cb19-619" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Identify groups with duplicates (2 or more parcels sharing the same address list)</span></span>
<span id="cb19-620"><a href="#cb19-620" aria-hidden="true" tabindex="-1"></a>    duplicate_groups <span class="op">=</span> {k: g <span class="cf">for</span> k, g <span class="kw">in</span> grouped <span class="cf">if</span> <span class="bu">len</span>(g) <span class="op">&gt;</span> <span class="dv">1</span>}</span>
<span id="cb19-621"><a href="#cb19-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-622"><a href="#cb19-622" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Print full info for each group of duplicated parcels</span></span>
<span id="cb19-623"><a href="#cb19-623" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üì¶ Duplicate parcels with identical address lists:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-624"><a href="#cb19-624" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, group <span class="kw">in</span> duplicate_groups.items():</span>
<span id="cb19-625"><a href="#cb19-625" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"üßµ Shared Address List (</span><span class="sc">{</span><span class="bu">len</span>(group)<span class="sc">}</span><span class="ss"> parcels):"</span>)</span>
<span id="cb19-626"><a href="#cb19-626" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> addr <span class="kw">in</span> key:</span>
<span id="cb19-627"><a href="#cb19-627" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>addr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-628"><a href="#cb19-628" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"üîç Full parcel records:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-629"><a href="#cb19-629" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(group.drop(columns<span class="op">=</span>[<span class="st">"AddressListKey"</span>]).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-630"><a href="#cb19-630" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-631"><a href="#cb19-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-632"><a href="#cb19-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-633"><a href="#cb19-633" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-634"><a href="#cb19-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-635"><a href="#cb19-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-636"><a href="#cb19-636" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exploring parcels with more than one address</span></span>
<span id="cb19-637"><a href="#cb19-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-638"><a href="#cb19-638" aria-hidden="true" tabindex="-1"></a>These lists can be used later in tool tips.</span>
<span id="cb19-639"><a href="#cb19-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-642"><a href="#cb19-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-643"><a href="#cb19-643" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter parcels that have more than one address</span></span>
<span id="cb19-644"><a href="#cb19-644" aria-hidden="true" tabindex="-1"></a>multi_address_parcels <span class="op">=</span> parcels_with_addresses[parcels_with_addresses[<span class="st">"AddressList"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">isinstance</span>(x, <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">1</span>)]</span>
<span id="cb19-645"><a href="#cb19-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-646"><a href="#cb19-646" aria-hidden="true" tabindex="-1"></a><span class="co"># Print a few examples</span></span>
<span id="cb19-647"><a href="#cb19-647" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üì¶ Parcels with multiple addresses:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-648"><a href="#cb19-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-649"><a href="#cb19-649" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> multi_address_parcels.head(<span class="dv">5</span>).iterrows():</span>
<span id="cb19-650"><a href="#cb19-650" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Parcel Index: </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-651"><a href="#cb19-651" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Address Count: </span><span class="sc">{</span><span class="bu">len</span>(row[<span class="st">'AddressList'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-652"><a href="#cb19-652" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Addresses:"</span>)</span>
<span id="cb19-653"><a href="#cb19-653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> addr <span class="kw">in</span> row[<span class="st">"AddressList"</span>]:</span>
<span id="cb19-654"><a href="#cb19-654" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>addr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-655"><a href="#cb19-655" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb19-656"><a href="#cb19-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-657"><a href="#cb19-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-658"><a href="#cb19-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-659"><a href="#cb19-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-662"><a href="#cb19-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-663"><a href="#cb19-663" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="dv">0</span>:</span>
<span id="cb19-664"><a href="#cb19-664" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect to or create a database file</span></span>
<span id="cb19-665"><a href="#cb19-665" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"fda-data.sqlite"</span>)</span>
<span id="cb19-666"><a href="#cb19-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-667"><a href="#cb19-667" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> [selector]<span class="op">+</span>features:</span>
<span id="cb19-668"><a href="#cb19-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-669"><a href="#cb19-669" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the DataFrame to a new table (overwrite if it exists)</span></span>
<span id="cb19-670"><a href="#cb19-670" aria-hidden="true" tabindex="-1"></a>        temp_copy <span class="op">=</span> data[feature].copy()</span>
<span id="cb19-671"><a href="#cb19-671" aria-hidden="true" tabindex="-1"></a>        temp_copy <span class="op">=</span> temp_copy.drop(columns<span class="op">=</span>[<span class="st">'geometry'</span>])</span>
<span id="cb19-672"><a href="#cb19-672" aria-hidden="true" tabindex="-1"></a>        temp_copy.to_sql(feature.lower(), conn, if_exists<span class="op">=</span><span class="st">"replace"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-673"><a href="#cb19-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-674"><a href="#cb19-674" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write out _in_fan features</span></span>
<span id="cb19-675"><a href="#cb19-675" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> feature<span class="op">==</span>selector:</span>
<span id="cb19-676"><a href="#cb19-676" aria-hidden="true" tabindex="-1"></a>            feature_name <span class="op">=</span> feature <span class="op">+</span> <span class="st">"_in_fan"</span></span>
<span id="cb19-677"><a href="#cb19-677" aria-hidden="true" tabindex="-1"></a>            temp_copy <span class="op">=</span> data[feature_name].copy()</span>
<span id="cb19-678"><a href="#cb19-678" aria-hidden="true" tabindex="-1"></a>            temp_copy <span class="op">=</span> temp_copy.drop(columns<span class="op">=</span>[<span class="st">'geometry'</span>])</span>
<span id="cb19-679"><a href="#cb19-679" aria-hidden="true" tabindex="-1"></a>            temp_copy.to_sql(feature_name.lower(), conn, if_exists<span class="op">=</span><span class="st">"replace"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-680"><a href="#cb19-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-681"><a href="#cb19-681" aria-hidden="true" tabindex="-1"></a>    conn.close()</span>
<span id="cb19-682"><a href="#cb19-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-683"><a href="#cb19-683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-684"><a href="#cb19-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-687"><a href="#cb19-687" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-688"><a href="#cb19-688" aria-hidden="true" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">"../data"</span></span>
<span id="cb19-689"><a href="#cb19-689" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_folder, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-690"><a href="#cb19-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-691"><a href="#cb19-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Write each GeoDataFrame in the dictionary to a GeoJSON file</span></span>
<span id="cb19-692"><a href="#cb19-692" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, gdf <span class="kw">in</span> data.items():</span>
<span id="cb19-693"><a href="#cb19-693" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(gdf, <span class="st">"to_file"</span>):  <span class="co"># Check it's a GeoDataFrame</span></span>
<span id="cb19-694"><a href="#cb19-694" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_folder, <span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">.geojson"</span>)</span>
<span id="cb19-695"><a href="#cb19-695" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(output_path, driver<span class="op">=</span><span class="st">"GeoJSON"</span>)</span>
<span id="cb19-696"><a href="#cb19-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-697"><a href="#cb19-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-698"><a href="#cb19-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-699"><a href="#cb19-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-700"><a href="#cb19-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## Available columns</span></span>
<span id="cb19-701"><a href="#cb19-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-704"><a href="#cb19-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-705"><a href="#cb19-705" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb19-706"><a href="#cb19-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-707"><a href="#cb19-707" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">":::: {.columns} "</span>)</span>
<span id="cb19-708"><a href="#cb19-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-709"><a href="#cb19-709" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="bu">round</span>(floor(<span class="fl">100.0</span> <span class="op">/</span> <span class="bu">len</span>( [selector] <span class="op">+</span> features )))</span>
<span id="cb19-710"><a href="#cb19-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-711"><a href="#cb19-711" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> [selector] <span class="op">+</span> features:</span>
<span id="cb19-712"><a href="#cb19-712" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> feature <span class="kw">in</span> features:</span>
<span id="cb19-713"><a href="#cb19-713" aria-hidden="true" tabindex="-1"></a>        feature <span class="op">=</span> feature <span class="op">+</span> <span class="st">"_in_fan"</span></span>
<span id="cb19-714"><a href="#cb19-714" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"""</span></span>
<span id="cb19-715"><a href="#cb19-715" aria-hidden="true" tabindex="-1"></a><span class="ss">::: </span><span class="ch">{{</span><span class="ss">.column width=</span><span class="sc">{</span>width<span class="sc">}</span><span class="ss">%</span><span class="ch">}}</span></span>
<span id="cb19-716"><a href="#cb19-716" aria-hidden="true" tabindex="-1"></a><span class="ss">### </span><span class="sc">{</span>feature<span class="sc">}</span></span>
<span id="cb19-717"><a href="#cb19-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-718"><a href="#cb19-718" aria-hidden="true" tabindex="-1"></a><span class="ss">| Property |</span></span>
<span id="cb19-719"><a href="#cb19-719" aria-hidden="true" tabindex="-1"></a><span class="ss">|----------|"""</span>)</span>
<span id="cb19-720"><a href="#cb19-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-721"><a href="#cb19-721" aria-hidden="true" tabindex="-1"></a>    columns <span class="op">=</span> data[feature].columns.tolist()</span>
<span id="cb19-722"><a href="#cb19-722" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columns:</span>
<span id="cb19-723"><a href="#cb19-723" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"| </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss"> |"</span>)</span>
<span id="cb19-724"><a href="#cb19-724" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"""</span></span>
<span id="cb19-725"><a href="#cb19-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-726"><a href="#cb19-726" aria-hidden="true" tabindex="-1"></a><span class="ss">::: </span></span>
<span id="cb19-727"><a href="#cb19-727" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb19-728"><a href="#cb19-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-729"><a href="#cb19-729" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">::::"</span>)</span>
<span id="cb19-730"><a href="#cb19-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>